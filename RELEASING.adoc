// SPDX-License-Identifier: Apache-2.0 OR EUPL-1.2
= Releasing jfmt
:toc: macro

This document describes the release process for jfmt using maven-release-plugin and GPG-signed releases.

toc::[]

== Overview

The release process consists of three phases:

1. **Phase 1: Local Maven Release** - Create GPG-signed tags locally using maven-release-plugin
2. **Phase 2: CI Native Builds** - Automated native binary builds triggered by tag push
3. **Phase 3: Local JReleaser** - Create GitHub release with all artifacts

== Phase 1: Local Maven Release

The maven-release-plugin handles version management and GPG signing.

=== Prerequisites

Before releasing:

1. All tests pass on the `main` branch
2. You have GPG configured for signing commits and tags
3. Git is configured with your GPG key:
+
[source,console]
----
git config --global user.signingkey <your-key-id>
git config --global commit.gpgsign true
git config --global tag.gpgsign true
----

=== Release Steps

[source,console]
----
# 1. Ensure you're on main with latest changes
git checkout main
git pull

# 2. Run maven-release-plugin (interactive)
./mvnw release:prepare release:perform

# You'll be prompted for:
# - Release version (e.g., 0.1.0)
# - SCM tag (default: v0.1.0)
# - Next development version (e.g., 0.1.1-SNAPSHOT)
----

**What happens:**

* Updates version to release version (removes `-SNAPSHOT`)
* Updates `<scm><tag>` in POM to the release tag
* Creates a GPG-signed commit: `[maven-release-plugin] prepare release v0.1.0`
* Creates a GPG-signed tag: `v0.1.0`
* Updates version to next development version
* Creates a GPG-signed commit: `[maven-release-plugin] prepare for next development iteration`
* Pushes commits and tags to GitHub
* Triggers the CI workflow (Phase 2)

=== Configuration

The maven-release-plugin is configured in the root `pom.xml` with the following key settings:

* **Tag format:** `v@{project.version}` (e.g., `v0.1.0`)
* **Goal:** `install` (deployment to Maven Central is skipped)
* **Auto-version submodules:** Enabled
* **Push changes:** Enabled (commits and tags are pushed automatically)

== Phase 2: CI Native Builds (Automated)

When you push a tag (e.g., `v0.1.0`), the `.github/workflows/build-release-artifacts.yml` workflow is automatically triggered.

=== What It Does

1. Checks out the tagged commit
2. Builds native binaries for all platforms using `.github/workflows/build-native.yml`:
   - Linux x86_64 (static binary with musl)
   - macOS x86_64 (Intel)
   - macOS aarch64 (Apple Silicon)
   - Windows x86_64
3. Creates distribution archives (`.zip` and `.tar.gz`) for each platform
4. Uploads all artifacts with 90-day retention

=== Monitoring the Build

Go to https://github.com/bmarwell/jfmt/actions and watch for the "Build Release Artifacts" workflow.

The workflow will show instructions for downloading artifacts in the final step.

== Phase 3: Local JReleaser

After CI builds complete, create the GitHub release locally with JReleaser.

=== Set GitHub Token

JReleaser needs a GitHub Personal Access Token with `repo` scope.

[source,console]
----
# Set environment variable (or add to ~/.bashrc or ~/.zshrc)
export JRELEASER_GITHUB_TOKEN=<your-github-pat>

# To create a token, visit:
# https://github.com/settings/tokens/new
# Required scopes: repo
----

=== Download Artifacts

[source,console]
----
# Get the workflow run ID from GitHub Actions UI or:
gh run list --workflow=build-release-artifacts.yml --limit 1

# Download artifacts to ./artifacts folder
gh run download <run-id> -n release-artifacts-v0.1.0 -D artifacts/

# Verify artifacts
ls -lh artifacts/
----

=== Create GitHub Release

[source,console]
----
# Checkout the release tag
git checkout v0.1.0

# Ensure you're in the project root directory
cd /path/to/jfmt

# Run JReleaser with downloaded artifacts
./mvnw -N -Prelease -DartifactsDir=artifacts jreleaser:full-release
----

**Note:** The `-DartifactsDir=artifacts` path is relative to the project root. Ensure you run this command from the repository root directory.

**What happens:**

* JReleaser creates a GitHub release linked to the tag
* Uploads all native binary artifacts
* Generates changelog from conventional commits
* Marks the release as latest

=== Verify the Release

Check https://github.com/bmarwell/jfmt/releases to see your new release.

== Testing the Release Process

Before performing an actual release, you can test the configuration with the provided dry-run script:

[source,console]
----
./test-release.sh
----

This script validates:

* Git and GPG configuration
* maven-release-plugin configuration
* CI workflow files
* JReleaser configuration
* Artifact path resolution

The script runs maven-release-plugin and JReleaser in dry-run mode without making any actual changes.

== Troubleshooting

=== maven-release-plugin Issues

**Problem:** Plugin fails with "Unable to commit files"

* Ensure Git is configured properly
* Check you have push access to the repository
* Verify GPG key is set up correctly

**Problem:** "Working directory is not clean"

* Commit or stash all local changes before releasing
* Run `git status` to check for uncommitted files

=== CI Build Failures

**Problem:** Native build fails

* Check the workflow logs in GitHub Actions
* Common issues:
  - GraalVM compatibility
  - Missing dependencies
  - Platform-specific compilation errors

=== JReleaser Issues

**Problem:** "Artifacts not found"

* Verify artifacts were downloaded to `./artifacts/`
* Check artifact naming matches pattern in `jreleaser.yml`

**Problem:** "GitHub API rate limit exceeded"

* Use a personal access token with sufficient permissions
* Wait for rate limit to reset

== Release Candidates

To create a release candidate (RC) instead of a final release:

[source,console]
----
# Run maven-release-plugin with RC version
./mvnw release:prepare release:perform

# When prompted for release version, enter: 0.1.0-rc.1
# When prompted for SCM tag, accept default: v0.1.0-rc.1
# When prompted for next development version, keep current: 0.1.0-SNAPSHOT
----

**What happens:**

* Creates tag `v0.1.0-rc.1` with RC version (SemVer 2.0.0 compliant)
* Returns to `0.1.0-SNAPSHOT` after release (not incremented)
* Allows multiple RC releases before final release (`0.1.0-rc.2`, `0.1.0-rc.3`, etc.)
* CI builds natives for the RC tag
* JReleaser creates a pre-release on GitHub

**Next steps:**

1. Follow Phase 2 and Phase 3 as usual
2. The GitHub release will be marked as "pre-release" automatically (detected by `-rc` suffix)
3. When ready for final release, run `./mvnw release:prepare release:perform` again with version `0.1.0`

== Rollback

If something goes wrong during release:

[source,console]
----
# Rollback the maven release (only if not pushed yet)
./mvnw release:rollback

# If already pushed, manually clean up:
# Delete the pushed tag
git push --delete origin v0.1.0
git tag -d v0.1.0

# Delete the GitHub release (if created)
gh release delete v0.1.0

# Reset commits (if release commits were pushed)
git reset --hard HEAD~2  # Revert prepare and next version commits
git push origin main --force
----

**For Release Candidates:**

If rolling back an RC release, the version should already be back at the SNAPSHOT version (e.g., `0.1.0-SNAPSHOT`).
No additional version changes are needed since RCs don't increment the next development version.

If you need to re-release an RC with the same number (e.g., `0.1.0-rc.1`), you must:

1. Delete the tag as shown above
2. Run `./mvnw release:prepare release:perform` again with the same RC version

== Advantages of This Process

✅ **GPG-signed commits and tags** - Full traceability and security

✅ **SCM tags properly managed** - Maven updates `<scm><tag>` automatically

✅ **Atomic operations** - maven-release-plugin handles rollback on failure

✅ **CI for cross-platform builds** - Native binaries built on proper platforms

✅ **Local control** - You verify artifacts before publishing

✅ **Standard Maven way** - Uses battle-tested maven-release-plugin

== References

* https://maven.apache.org/maven-release/maven-release-plugin/[Maven Release Plugin]
* https://jreleaser.org/[JReleaser Documentation]
* https://docs.github.com/en/authentication/managing-commit-signature-verification[GitHub: GPG Commit Signing]
